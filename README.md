1  能源区块链的微电网P2P电力交易
在微电网中，以分布式能源为交易对象，借助区块链技术作为交易支撑，利用双边拍卖与博弈论技术作为理论框架，实现P2P电力交易。分布式能源P2P电力交易的参与者有绿色能源发电商(green energy generators, GEGs), 负责生成可再生能源，如太阳能、风能等，并将电力输出到微电网。电力消费者(electricity consumers, ECs)，负责购买电力以满足用电需求。电力调度商(electricity dispatcher, ED), 负责在发电商无法出售其全部产生的电力时进行回收，并在电力消费者需求超过绿色能源发电商发电量时提供补充电力，为确保供应稳定性，补充电力采用传统能源电力。从而平衡市场供需并确保电力系统的稳定运行。监管机构(regulatory authorities, RA)，主要起到监管和追责定责等作用，以确保买卖双方能够按照交易订单完成电力交接，并对违约的一方进行一定的惩罚。
1.1交易架构
在能源区块链环境下进行电力的点对点交易，对提升数据安全性、增强参与者信任性、提高交易效率等方面增添很大助力。而微电网电力交易关系着整个微电网系统的可靠稳定运行。因此，本节将在微电网物理传输、能源区块链环境以及主从博弈的协助下设计点对点电力交易。
1.2交易流程
首先，各参与者作为独立节点加入能源区块链并完成身份验证与注册。其次，绿色能源发电商与电力消费者分别提交下一时间段内的预计发电量、预计电价或预计用电量至链上。接着，进入交易匹配阶段。在交易匹配的第一阶段，智能合约获取发布的信息并进行排序，根据排序结果为买卖双方进行匹配，匹配成功后，智能合约生成临时交易订单并发送给相关参与者等待确认。未匹配成功的参与者将进入下一阶段。在交易匹配的第二阶段，将多个绿色能源发电商聚合为一个整体，作为单一领导者，与多个电力消费者即跟随者进行主从博弈。领导者以最优电价为目标，跟随者以购买绿色能源发电商能源与电力调度商能源的最优比例为目标。根据博弈结果智能合约为前一阶段未匹配成功的参与者生成临时交易订单并发送给相关参与者等待确认。最后，智能合约将第一阶段与第二阶段生成的临时交易订单整合并经双方确认之后，生成最终交易订单并上链存储。


 
2  双边拍卖阶段
双边拍卖作为一种市场机制，旨在实现买卖双方在价格和数量上的有效匹配，适用于处理分布式能源市场中绿色能源发电商与电力消费者之间的供需关系[.]。通过引入竞争性市场环境，双边拍卖为各参与者提供了公平且高效的交易平台，涉及要素包括买卖双方、报价、出价、匹配算法、交易规则、市场清算等。
假设该微电网区域内由\[n\]个绿色能源发电商GEGs、\[m\]个电力消费者ECs组成，用集合\[N=\{1,2,\cdots ,n\}\]表示绿色能源发电商GEGs，集合\[M=\{1,2,\cdots ,m\}\]表示电力消费者ECs，其中每个绿色能源发电商GEGs用\[i\]表示，\[i\in N\]，每个电力消费者ECs用\[j\]表示，\[j\in M\]。交易的匹配是针对未来的某一时间段进行的，用上标\[t\]的符号表示在时间段\[t\]的范围内。
2. 1 匹配机制
在双边拍卖过程中，各个绿色能源发电商\[G_{i}^{{}}\]提交双边拍卖阶段的电力售价\[p_{ag,i}^{t}\]和预期发电量\[q_{ag,i}^{t}\]；而各个电力消费者\[C_{j}^{{}}\]则提交双边拍卖阶段的电力购价\[p_{ac,j}^{t}\]和预期用电量\[q_{ac,j}^{t}\]。然后将绿色能源发电商的电力售价\[p_{ag,i}^{t}\]按照从低到高依次排列，对于电力售价\[p_{ag,i}^{t}\]相同的绿色能源发电商，按照预期发电量\[q_{ag,i}^{t}\]从大到小依次排序，形成出售数组；同时，电力消费者的电力购价\[p_{ac,j}^{t}\]按照从高到低依次排列，对于电力购价\[p_{ac,j}^{t}\]相同的电力消费者，按照预期用电量\[q_{ac,j}^{t}\]从大到小依次排序，形成购买数组。
分别选择两数组中的第1个元素电力售价\[p_{ag,i}^{t}\]与电力购价\[p_{ac,j}^{t}\]，如果满足\[p_{ag,i}^{t}\le p_{ac,j}^{t}\]，则匹配成功，并按照以下步骤处理：
a. 确定交易量。以预期发电量\[q_{ag,i}^{t}\]和预期用电量\[q_{ac,j}^{t}\]中的较小值作为交易量\[q_{a,ij}^{t}\]。
b. 记录交易详情，包括交易量\[q_{a,ij}^{t}\]、GEGs的电力售价\[p_{ag,i}^{t}\]和ECs的电力购价\[p_{ac,j}^{t}\]。
c.若\[q_{ag,i}^{t}<q_{ac,j}^{t}\]，则令 
\[q_{ac,j}^{t}=q_{ac,j}^{t}-q_{a,ij}^{t}\]                  (1)
即当ECs匹配成功但未购买到足够的电力时，将其在数组中的预期用电量\[q_{ac,j}^{t}\]修改为未被满足的预期用电量，使其继续参与拍卖流程，然后从出售数组中移除匹配成功的GEGs。
若\[q_{ag,i}^{t}>q_{ac,j}^{t}\]，则令 
\[q_{ag,i}^{t}=q_{ag,i}^{t}-q_{a,ij}^{t}\]                  (1)
即当GEGs匹配成功但未售尽预期发电量时，将其在数组中的预期发电量\[q_{ag,i}^{t}\]修改为未售尽的预期发电量，使其继续参与拍卖流程，然后从购买数组中移除匹配成功的GEGs。
若\[q_{ag,i}^{t}=q_{ac,j}^{t}\]，则从出售数组与购买数组中移除匹配成功的GEGs与ECs。
重复上述步骤直至出售数组或购买数组其中一方数组清空，或出现\[p_{ag,i}^{t}>p_{ac,j}^{t}\]，则双边拍卖匹配阶段结束，进入双边拍卖的清算阶段。
2. 2 清算机制
本文的双边拍卖使用平均混合价格的清算机制以平衡买卖双方的利益[.]，即匹配成功的双边拍卖订单的成交价格综合考虑GEGs与ECs的出价以及ED的电力回收与出售价格。
由于ED的功能为确保电力供应稳定性，因此ED的电力回收价格\[p_{b}^{{}}\]以及电力出售价格\[p_{s}^{{}}\]为固定值，不会轻易变动。
首先根据匹配成功的绿色能源发电商\[G_{i}^{{}}\]的电力售价\[p_{ag,i}^{t}\]与电力消费者\[C_{j}^{{}}\]的电力购价\[p_{ac,j}^{t}\]，计算出平均价格\[p_{a,ij}^{t}\]。如式( )所示。
\[p_{a,ij}^{t}=(p_{ag,i}^{t}+p_{ac,j}^{t})/2\]                  (1)
接着在平均价格基础上，考虑ED的电力回收价格\[p_{b}^{{}}\]以及电力出售价格\[p_{s}^{{}}\]，计算出混合价格\[p_{m,ij}^{t}\]，考虑ED的电力出售价格\[p_{s}^{{}}\]与GEGs的电力售价\[p_{ag,i}^{t}\]的差值，ECs的电力购价\[p_{ac,j}^{t}\]与ED电力回收价格\[p_{b}^{{}}\]的差值。前者差值越小表明GEGs的收益越大，后者差值越大表明ECs的收益越大。如式( )所示。
\[\begin{align}
  & p_{m,ij}^{t}=p_{a,ij}^{t}/2-(p_{s}^{{}}-p_{ag,i}^{t})/2+ \\ 
 & (p_{ac,j}^{t}-p_{b}^{{}})/2 \\ 
\end{align}\]                  (1)
最后在平均价格与混合价格基础上，计算出平均混合价格\[p_{am,ij}^{t}\]，可以同时兼顾平均价格与混合价格，能够平衡买卖双方的利益。
如式( )所示。
\[p_{am,ij}^{t}=(p_{a,ij}^{t}+p_{m,ij}^{t})/2\]                  (1)
将平均混合价格\[p_{am,ij}^{t}\]作为双边拍卖最终清算价格，并将平均混合价格\[p_{am,ij}^{t}\]与其对应的交易量\[q_{a,ij}^{t}\]存入双边拍卖成交数组，最后生成临时交易订单并发送给相关参与者等待确认。
此时双边拍卖阶段结束。通过这个流程，双边拍卖在一定程度上实现了电力市场买卖双方的匹配，但仍有部分未匹配成功的双方需要进一步解决。由此进入博弈阶段以解决这些未匹配成功的参与者之间的策略互动问题。


3  主从博弈阶段
主从博弈属于博弈论的范畴。而博弈论是一种在参与人完全理性的情况下研究决策问题的理论，它为解决不同参与者之间利益冲突问题提供了思路，包括参与者、行动、信息、策略、支付、结果和均衡等元素[15]。因此，在处理绿色能源发电商与电力消费者间潜在的利益冲突时，运用主从博弈是一种行之有效的方法。
在本节中将建立一个主从博弈模型，用于解决绿色能源发电商与电力消费者之间的电力交易问题。通过博弈模型找到绿色能源发电商的最优的电价以及电力消费者购买绿色能源发电商能源与电力调度商能源的最优比例，以实现绿色能源发电商和电力消费者双方的利益最大化。
2. 1  绿色能源发电商模型
为简化博弈模型并提高计算效率，提出一种将多个绿色能源发电商整合为一个单一实体的方法。当绿色能源发电商与电力消费者进行交易时，电价、供应和需求的匹配问题可能变得非常复杂。通过将多个绿色能源发电商整合为一个单一实体，可以降低博弈过程中参与者之间的复杂性，从而更容易找到公平和可行的解决方案。
使用双边拍卖阶段成交的电价的平均值作为整合后的统一电价。即计算拍卖阶段成功匹配的每个订单的电价与电量的乘积之和，然后将其除以拍卖阶段成功匹配的总电量。如式( )所示。
\[P=\frac{\sum\limits_{l=1}^{k}{{{p}_{l}}}{{q}_{l}}}{\sum\limits_{l=1}^{k}{{{q}_{l}}}}\]                            ()
式中：\[k\]表示拍卖阶段成功匹配的订单数，\[{{p}_{l}}\]表示第\[l\]个订单的成交电价，其中\[l=1,2,\ldots ,k\]，\[{{q}_{l}}\]表示第\[l\]个订单的成交电量。\[P_{{}}^{t}\]表示整合后的统一电价，将其作为第一次参与博弈时的电价。
绿色能源发电商的目标是最大化自身的收益，因此GEGs的收益函数\[R_{g}^{t}\]需要考虑到售电收益\[SR_{g}^{t}\]、绿色能源补贴\[ES_{g}^{t}\]、发电成本\[GC_{g}^{t}\]、以及服务费\[SF_{g}^{t}\]。其中，售电收益是由发电商向电力消费者售电收益以及向电力调度商售电收益两部分组成；为鼓励绿色能源发电商与电力消费者之间的交易，基于绿色能源发电商售给电力消费者的电量给予补贴；发电成本通常不是线性的，更多的情况是随着发电量的增加，单位发电成本逐渐下降，但在一定范围内又会逐渐上升，比如因为设备磨损、维护成本的增加等。因此，假设发电成本为一个二次函数。
其收益函数如公式(1)(2)所示
    \[\left\{ \begin{align}
  & max\text{  R}_{g}^{t}\text{=}SR_{g}^{t}+ES_{g}^{t}-GC_{g}^{t}-SF_{g}^{t} \\ 
 & s.t. \\ 
 & SR_{g}^{t}=\sum\limits_{j=1}^{M}{{{P}^{t}}}q_{j}^{t}+({{Q}^{t}}-\sum\limits_{j=1}^{M}{q_{j}^{t}}){{p}_{b}} \\ 
 & ES_{g}^{t}\text{=}\omega \sum\limits_{j=1}^{M}{q_{j}^{t}} \\ 
 & GC_{g}^{t}\text{=}c_{1}^{{}}{{({{Q}^{t}})}^{2}}\text{+}c_{2}^{{}}{{Q}^{t}}+c_{3}^{{}}\text{  } \\ 
 & F_{te}^{t}\text{=}{{\varphi }_{te}}\frac{1}{2}(p_{te}^{t}+p_{re}^{t})\sum\limits_{i=1}^{{{n}_{1}}+{{n}_{2}}+{{n}_{3}}}{x_{te,i}^{t}} \\ 
\end{align} \right.\]   (1)
式中：\[q_{j}^{t}\]表示电力消费者\[j\]从领导者处购买的电量；\[M\]表示跟随者的数量，即所有参与到博弈阶段的电力消费者的数量；\[{{Q}^{t}}\]表示领导者的总发电量，即所有参与到博弈阶段的绿色能源发电商的发电量之和；\[\omega \]表示绿色能源补贴因子；\[c_{1}^{{}}\]、\[c_{2}^{{}}\]和\[c_{3}^{{}}\]是参数，需要根据实际情况来设定；。

（下面这一部分放到最后）
为了在博弈完成后公平合理地将统一交易产生的收益分配给每个绿色能源发电商，需要考虑各个发电商的发电成本，确保收益分配与发电成本成正比，从而实现公平合理的收益分配。首先计算收益分配系数，如式( )所示。
\[{{s}_{i}}=\frac{{{c}_{i}}}{\sum\limits_{j=i}^{n}{{{c}_{i}}}}\]                             (1)
式中：\[{{c}_{i}}\]表示第\[i\]个绿色能源发电商的发电成本，\[i\in 1,2,\ldots ,n\]，\[n\]表示发电商的数量，\[{{s}_{i}}\]表示第\[i\]个绿色能源发电商的收益分配系数。
然后计算每个绿色能源发电商的收益\[{{r}_{i}}\]，如式( )所示。
\[{{r}_{i}}={{s}_{i}}\cdot R.\]                  (1)
式中：\[R\]为博弈阶段的总收益。

